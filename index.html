<!DOCTYPE html>
<html>
<head>
    <title>Audio Recorder</title>
</head>
<body>
    <button id="start">Start</button>
    <button id="stop">Stop</button>
    <br>
    <button id="play">Play</button>
    <audio id="audio"></audio>
    <br>
    <input type="text" id="lambdaURL" placeholder="Lambda Endpoint URL">
    <button id="post">POST to Lambda</button>

    <script>
        let chunks = [];
        let mediaRecorder;
        let blob;

        navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.onstart = () => {
                chunks = [];
            };

            mediaRecorder.ondataavailable = e => {
                chunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                blob = new Blob(chunks, { 'type' : 'audio/ogg; codecs=opus' });
                const audioURL = URL.createObjectURL(blob);
                document.querySelector('#audio').src = audioURL;
            };
        });

        document.querySelector('#start').onclick = () => {
            mediaRecorder.start();
        };

        document.querySelector('#stop').onclick = () => {
            mediaRecorder.stop();
        };

        document.querySelector('#play').onclick = () => {
            document.querySelector('#audio').play();
        };

        document.querySelector('#post').onclick = async () => {
            try {
                let lambdaURL = document.querySelector("#lambdaURL").value;
                let reader = new FileReader();
                reader.onloadend = async function() {
                    let base64data = reader.result;
                    let response = await fetch(lambdaURL, {
                        method: 'POST',
                        body: JSON.stringify({audio: base64data})
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    let data = await response.json();
                    console.log(data);
                }
                reader.readAsDataURL(blob); // converts the blob to base64 and calls onloadend
            } catch (error) {
                console.error('There has been a problem with your fetch operation:', error);
            }
        };
    </script>
</body>
</html>

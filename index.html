<!DOCTYPE html>
<html>
    <head>
        <title>Audio Recorder v2.0</title>
    </head>
    <body>
        <button id="start">Start Recording</button>
        <p id="status"></p>
        <audio id="player" controls></audio>
        <div id="log"></div>

        <script>
            var button = document.getElementById('start');
            var status = document.getElementById('status');
            var player = document.getElementById('player');
            var logDiv = document.getElementById('log');

            function log(message) {
                console.log(message);
                var p = document.createElement('p');
                p.appendChild(document.createTextNode(message));
                logDiv.appendChild(p);
            }

            button.onclick = function() {
                log('Recording...');
                navigator.mediaDevices.getUserMedia({audio: true})
                    .then(stream => {
                        log('Asking for permission...');
                        const mediaRecorder = new MediaRecorder(stream);
                        mediaRecorder.start();

                        const audioChunks = [];
                        mediaRecorder.addEventListener("dataavailable", event => {
                            audioChunks.push(event.data);
                        });

                        mediaRecorder.addEventListener("stop", () => {
                            log('Finished recording, now playing back...');
                            const audioBlob = new Blob(audioChunks);
                            const audioUrl = URL.createObjectURL(audioBlob);
                            player.src = audioUrl;

                            if (audioUrl) {
                                log("Audio URL created: " + audioUrl);
                            } else {
                                log("Failed to create audio URL");
                            }

                            player.onloadedmetadata = function() {
                                log("Audio metadata loaded");
                                player.play();
                            };

                            player.onerror = function(e) {
                                log("Error playing audio: " + e);
                            };
                        });

                        setTimeout(() => {
                            log('Permission granted, now stopping...');
                            mediaRecorder.stop();
                        }, 3000);
                    });
            };
        </script>
    </body>
</html>
